\hypertarget{mapmat_8c}{\section{mapmat.\-c}
\label{mapmat_8c}\index{mapmat.\-c@{mapmat.\-c}}
}

\begin{DoxyCode}
00001 
00009 \textcolor{preprocessor}{#ifdef W\_MPI }
00010 \textcolor{preprocessor}{}\textcolor{preprocessor}{ #include <mpi.h>}
00011 \textcolor{preprocessor}{#endif}
00012 \textcolor{preprocessor}{}\textcolor{preprocessor}{#include <stdio.h>}
00013 \textcolor{preprocessor}{#include <stdlib.h>}
00014 \textcolor{preprocessor}{#include <string.h>}
00015 \textcolor{preprocessor}{#include "\hyperlink{mapmat_8h}{mapmat.h}"}
00016 
00017 
\hypertarget{mapmat_8c_source_l00043}{}\hyperlink{group__matmap__group11_ga16fec1005b6f01bda1dd6154c26c27ed}{00043} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga16fec1005b6f01bda1dd6154c26c27ed}{MatInit}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} nnz, \textcolor{keywordtype}{int} *indices, \textcolor{keywordtype}{double} *values, \textcolor{keywordtype}{int}
       flag
00044 #ifdef W\_MPI
00045 , MPI\_Comm comm
00046 #endif
00047 )\{
00048   \textcolor{keywordtype}{int} err;
00049   \hyperlink{group__matmap__group11_gaaf26c7678367e6757392c03abd22a105}{MatSetIndices}(A, m, nnz, indices);
00050 
00051   \hyperlink{group__matmap__group11_gad3d5adb742e7a82454fcd6eede21da91}{MatSetValues}(A, m, nnz, values);
00052 
00053   err = \hyperlink{group__matmap__group11_gae31f7ccb10cda5c97e49f640feed1ad4}{MatLocalShape}(A, 3);               \textcolor{comment}{// compute lindices
       (local columns) (method 3 = counting sort)}
00054 
00055 \textcolor{preprocessor}{#ifdef W\_MPI}
00056 \textcolor{preprocessor}{}  err = \hyperlink{group__matmap__group11_ga61b3b348d7c039aadfc3196e6b83535a}{MatComShape}(A, flag, comm);          \textcolor{comment}{// build communication
       scheme}
00057 \textcolor{preprocessor}{#endif}
00058 \textcolor{preprocessor}{}  \textcolor{keywordflow}{return} err;
00059 \}
00060 
00061 
\hypertarget{mapmat_8c_source_l00070}{}\hyperlink{group__matmap__group11_gaaf26c7678367e6757392c03abd22a105}{00070} \textcolor{keywordtype}{void} \hyperlink{group__matmap__group11_gaaf26c7678367e6757392c03abd22a105}{MatSetIndices}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} nnz, \textcolor{keywordtype}{int} *indices)\{
00071   A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}    = m;                         \textcolor{comment}{// set number of local rows}
00072   A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}  = nnz;                     \textcolor{comment}{// set number of non-zero values per
       row}
00073   A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices} = indices;                  \textcolor{comment}{// point to indices }
00074 \}
00075 
00076 
\hypertarget{mapmat_8c_source_l00085}{}\hyperlink{group__matmap__group11_gad3d5adb742e7a82454fcd6eede21da91}{00085} \textcolor{keywordtype}{void} \hyperlink{group__matmap__group11_gad3d5adb742e7a82454fcd6eede21da91}{MatSetValues}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{int} m, \textcolor{keywordtype}{int} nnz, \textcolor{keywordtype}{double} *values)\{
00086   \textcolor{keywordtype}{int} err;
00087   A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}    = m;                         \textcolor{comment}{// set number of local rows}
00088   A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}  = nnz;                     \textcolor{comment}{// set number of non-zero values per
       row}
00089   A->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}  = values;                    \textcolor{comment}{// point to values}
00090 \}
00091 
00092 \textcolor{comment}{//===================Part added by Sebastien Cayrols to get amount of memory
       needed by communication algoritms}
\hypertarget{mapmat_8c_source_l00093}{}\hyperlink{mapmat_8c_ad10eb11039e919a4596a6f1cc5abe812}{00093} \textcolor{keywordtype}{void} \hyperlink{mapmat_8c_ad10eb11039e919a4596a6f1cc5abe812}{CommInfo}(\hyperlink{structMat}{Mat} *A)\{
00094 \textcolor{preprocessor}{#if W\_MPI}
00095 \textcolor{preprocessor}{}  \textcolor{keywordtype}{int} i=0,size,rank;
00096   \textcolor{keywordtype}{double} maxSizeR = 0.0;
00097   \textcolor{keywordtype}{double} maxSizeS = 0.0;
00098   \textcolor{keywordtype}{double} amountSizeR = 0.0;
00099   \textcolor{keywordtype}{double} amountSizeS = 0.0;
00100   \textcolor{keywordtype}{double} stepSum=0.0,stepAvg=0.0;
00101   \textcolor{comment}{//this value is based on data sent}
00102   \textcolor{keywordtype}{double} *amountSizeByStep = NULL;
00103   \textcolor{keywordtype}{double} minStep=0.0, maxStep=0.0;
00104   \textcolor{keywordtype}{double} *s=NULL;
00105   \textcolor{keywordtype}{double} *r=NULL;
00106   MPI\_Comm comm = MPI\_COMM\_WORLD;
00107   MPI\_Comm\_rank(comm,&rank);
00108   MPI\_Comm\_size(comm,&size);
00109   s = malloc(4*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));
00110   r = malloc(4*3*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));
00111   amountSizeByStep = malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));
00112   \textcolor{keywordflow}{switch}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag})\{
00113     \textcolor{keywordflow}{case} NONE :
00114       \textcolor{keywordflow}{break};
00115     \textcolor{keywordflow}{case} BUTTERFLY :
00116       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00117         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00118         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00119         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00120           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00121         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00122           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00123       \}
00124     \textcolor{keywordflow}{break};
00125     \textcolor{comment}{//==========================Modification added by Sebastien Cayrols :
       01/09/2015 , Berkeley}
00126     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_1 :
00127       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00128         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00129         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00130         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00131           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00132         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00133           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00134       \}
00135     \textcolor{keywordflow}{break};
00136     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_2 :
00137       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00138         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00139         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00140         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00141           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00142         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00143           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00144       \}
00145     \textcolor{keywordflow}{break};
00146     \textcolor{keywordflow}{case} NOEMPTYSTEPRING :
00147       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00148         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00149         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00150         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00151           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00152         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00153           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00154       \}
00155     \textcolor{keywordflow}{break};
00156     \textcolor{comment}{//==========================End modification}
00157     \textcolor{keywordflow}{case} RING :
00158       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00159         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00160         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00161         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00162           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00163         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00164           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00165       \}
00166     \textcolor{keywordflow}{break};
00167     \textcolor{keywordflow}{case} NONBLOCKING :
00168       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00169         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00170         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00171         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00172           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00173         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00174           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00175       \}
00176     \textcolor{keywordflow}{break};
00177     \textcolor{keywordflow}{case} NOEMPTY :
00178       \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00179         amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00180         amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00181         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i]>maxSizeR)
00182           maxSizeR=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00183         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]>maxSizeS)
00184           maxSizeS=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00185       \}
00186     \textcolor{keywordflow}{break};
00187     \textcolor{keywordflow}{case} ALLTOALLV :          \textcolor{comment}{// added -- rs 2015/02/04}
00188           \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00189              amountSizeR +=A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[i];
00190              amountSizeS +=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00191           \}
00192     \textcolor{keywordflow}{break};
00193     \textcolor{keywordflow}{case} ALLREDUCE :
00194       amountSizeR = A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count};
00195       amountSizeS = A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count};
00196       maxSizeR    = A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count};
00197       maxSizeS    = A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count};
00198     \textcolor{keywordflow}{break};
00199   \}
00200 
00201   \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag} != ALLREDUCE && A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag} != ALLTOALLV )\{
00202     \textcolor{keywordtype}{double} *t=NULL;
00203 
00204     t=malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));
00205     \textcolor{comment}{// Copy int array into double array}
00206     \textcolor{keywordflow}{for}(i=0;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)
00207       t[i]=A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00208 
00209     MPI\_Reduce(t,amountSizeByStep,A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps},MPI\_DOUBLE,MPI\_SUM,0,comm);
00210     
00211     free(t);
00212     
00213     \textcolor{keywordflow}{if}(rank==0)\{
00214       stepSum=minStep=maxStep=amountSizeByStep[0];
00215       printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Step n°%4d, message size : %e"},0,amountSizeByStep[0]);
00216       \textcolor{keywordflow}{for}(i=1;i<A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};i++)\{
00217         printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Step n°%4d, message size : %e"},i,amountSizeByStep[i])
      ;
00218         \textcolor{keywordflow}{if}(minStep>amountSizeByStep[i])
00219           minStep=amountSizeByStep[i];
00220         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(maxStep<amountSizeByStep[i])
00221           maxStep=amountSizeByStep[i];
00222         stepSum+=amountSizeByStep[i];
00223       \}
00224       stepAvg=stepSum/A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps};
00225     \}
00226   \}
00227   s[0]=amountSizeR;
00228   s[1]=amountSizeS;
00229   s[2]=maxSizeR;
00230   s[3]=maxSizeS;
00231   MPI\_Reduce(s,r,4,MPI\_DOUBLE,MPI\_SUM,0,comm);
00232   \textcolor{keywordflow}{if}(rank==0)
00233     \textcolor{keywordflow}{for}(i=0;i<4;i++)
00234       r[i]/=size;
00235   MPI\_Reduce(s,&r[4],4,MPI\_DOUBLE,MPI\_MIN,0,comm);
00236   MPI\_Reduce(s,&r[8],4,MPI\_DOUBLE,MPI\_MAX,0,comm);
00237   \textcolor{keywordflow}{if}(rank==0)\{
00238     printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Step average             : %e\(\backslash\)t[%e,%e]"},stepAvg,minStep,
      maxStep);
00239     printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Amount of data received  : %e\(\backslash\)t[%e,%e]"}, r[0],r[4],r[8]);
00240     printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Amount of data sent      : %e\(\backslash\)t[%e,%e]"}, r[1],r[5],r[9]);
00241     printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Message size received    : %e\(\backslash\)t[%e,%e]"},r[2],r[6],r[10]);
00242     printf(\textcolor{stringliteral}{"\(\backslash\)n[MEMORY]Message size sent        : %e\(\backslash\)t[%e,%e]\(\backslash\)n"},r[3],r[7],r[11]
      );
00243   \}
00244   free(s);
00245   free(r);
00246   free(amountSizeByStep );
00247 \textcolor{preprocessor}{#endif}
00248 \textcolor{preprocessor}{}\}
00249 
\hypertarget{mapmat_8c_source_l00250}{}\hyperlink{mapmat_8c_a6f1974406caa5205fdada6efa9ca2798}{00250} \textcolor{keywordtype}{void} \hyperlink{mapmat_8c_a6f1974406caa5205fdada6efa9ca2798}{MatReset}(\hyperlink{structMat}{Mat} *A)\{
00251 \textcolor{preprocessor}{#if W\_MPI}
00252 \textcolor{preprocessor}{}  \textcolor{keywordflow}{switch}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag})\{
00253     \textcolor{keywordflow}{case} NONE :
00254       \textcolor{keywordflow}{break};
00255     \textcolor{keywordflow}{case} BUTTERFLY :
00256       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00257       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00258       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00259       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00260     \textcolor{keywordflow}{break};
00261     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_1 :
00262       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00263       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00264       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00265       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00266     \textcolor{keywordflow}{break};
00267     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_2 :
00268       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00269       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00270       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00271       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00272     \textcolor{keywordflow}{break};
00273     \textcolor{keywordflow}{case} NOEMPTYSTEPRING :
00274       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00275       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00276       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00277       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00278     \textcolor{keywordflow}{break};
00279     \textcolor{keywordflow}{case} RING :
00280       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00281       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00282       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00283       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00284     \textcolor{keywordflow}{break};
00285     \textcolor{keywordflow}{case} NONBLOCKING :
00286       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00287       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00288       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00289       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00290     \textcolor{keywordflow}{break};
00291     \textcolor{keywordflow}{case} NOEMPTY :
00292       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00293       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00294       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00295       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00296     \textcolor{keywordflow}{break};
00297     \textcolor{keywordflow}{case} ALLTOALLV :    \textcolor{comment}{// added -- rs 2015/02/04}
00298           free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});          \textcolor{comment}{//}
00299           free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});                \textcolor{comment}{//}
00300           free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});          \textcolor{comment}{//}
00301           free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00302     \textcolor{keywordflow}{break};
00303     \textcolor{keywordflow}{case} ALLREDUCE :
00304     \textcolor{keywordflow}{break};
00305   \}
00306 \textcolor{preprocessor}{#endif}
00307 \textcolor{preprocessor}{}\}
00308 
00309 \textcolor{comment}{//===================End}
00310 
\hypertarget{mapmat_8c_source_l00317}{}\hyperlink{group__matmap__group11_ga4e1732c63feba9e589b5037d0a25ab75}{00317} \textcolor{keywordtype}{void} \hyperlink{group__matmap__group11_ga4e1732c63feba9e589b5037d0a25ab75}{MatFree}(\hyperlink{structMat}{Mat} *A)\{
00318   
00319   \textcolor{comment}{//get information about communication size}
00320   \hyperlink{mapmat_8c_ad10eb11039e919a4596a6f1cc5abe812}{CommInfo}(A);
00321 
00322   free(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices});
00323 \textcolor{preprocessor}{#if W\_MPI}
00324 \textcolor{preprocessor}{}  \textcolor{keywordflow}{switch}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag})\{
00325     \textcolor{keywordflow}{case} NONE :
00326       \textcolor{keywordflow}{break};
00327     \textcolor{keywordflow}{case} BUTTERFLY :
00328       free(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices});  \textcolor{comment}{//}
00329       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00330       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00331       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00332       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00333     \textcolor{keywordflow}{break};
00334     \textcolor{comment}{//==========================Modification added by Sebastien Cayrols :
       01/09/2015 , Berkeley}
00335     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_1 :
00336       free(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices});  \textcolor{comment}{//}
00337       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00338       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00339       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00340       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00341     \textcolor{keywordflow}{break};
00342     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_2 :
00343       free(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices});  \textcolor{comment}{//}
00344       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00345       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00346       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00347       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00348     \textcolor{keywordflow}{break};
00349     \textcolor{keywordflow}{case} NOEMPTYSTEPRING :
00350       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00351       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00352       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00353       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00354     \textcolor{keywordflow}{break};
00355     \textcolor{comment}{//==========================End modification}
00356     \textcolor{keywordflow}{case} RING :
00357       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00358       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00359       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00360       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00361     \textcolor{keywordflow}{break};
00362     \textcolor{keywordflow}{case} NONBLOCKING :
00363       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00364       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00365       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00366       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00367     \textcolor{keywordflow}{break};
00368     \textcolor{keywordflow}{case} NOEMPTY :
00369       free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});              \textcolor{comment}{//}
00370       free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});            \textcolor{comment}{//}
00371       free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});              \textcolor{comment}{//}
00372       free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00373     \textcolor{keywordflow}{break};
00374     \textcolor{keywordflow}{case} ALLTOALLV :    \textcolor{comment}{// Added: rs 2015/02/04}
00375           free(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R});          \textcolor{comment}{//}
00376           free(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR});                \textcolor{comment}{//}
00377           free(A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S});          \textcolor{comment}{//}
00378           free(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS});
00379     \textcolor{keywordflow}{break};
00380     \textcolor{keywordflow}{case} ALLREDUCE :
00381       free(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices});  \textcolor{comment}{//}
00382 \textcolor{comment}{//===================================Modification from Sebastien Cayrols :
       comment of these lines to avoid SEGSIGV}
00383 \textcolor{comment}{//      free(A->R);             //}
00384 \textcolor{comment}{//      free(A->nR);            //}
00385 \textcolor{comment}{//      free(A->S);             //}
00386 \textcolor{comment}{//      free(A->nS);}
00387 \textcolor{comment}{//===================================End modif}
00388     \textcolor{keywordflow}{break};
00389   \}
00390 \textcolor{preprocessor}{#endif}
00391 \textcolor{preprocessor}{}\}
00392 
00393 
\hypertarget{mapmat_8c_source_l00403}{}\hyperlink{group__matmap__group11_ga56b5e9bda4e4ad0a2c4f2f12e94d077e}{00403} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga56b5e9bda4e4ad0a2c4f2f12e94d077e}{MatLoad}(\hyperlink{structMat}{Mat} *mat, \textcolor{keywordtype}{char} *filename)\{
00404   \textcolor{keywordtype}{int} err;
00405   \textcolor{keywordtype}{int} rank;
00406 \textcolor{preprocessor}{#if W\_MPI}
00407 \textcolor{preprocessor}{}  MPI\_Comm\_rank(mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &rank);
00408 \textcolor{preprocessor}{#else}
00409 \textcolor{preprocessor}{}  rank=0;
00410 \textcolor{preprocessor}{#endif }
00411 \textcolor{preprocessor}{}  FILE *in;
00412   \textcolor{keywordtype}{char} fn[100];
00413   \textcolor{keywordtype}{int} i=0;
00414   sprintf(fn, \textcolor{stringliteral}{"%s\_%d.dat"}, filename, rank);
00415   printf(\textcolor{stringliteral}{"%s"}, fn);
00416   in=fopen(fn,\textcolor{stringliteral}{"r"});
00417   \textcolor{keywordflow}{if}(in==NULL)\{
00418      printf(\textcolor{stringliteral}{"cannot open file %s"}, fn);
00419      \textcolor{keywordflow}{return} 1;
00420   \}
00421   \textcolor{keywordflow}{while}(feof(in)== 0 && i< (mat->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m} * mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}))\{
00422     \textcolor{keywordflow}{if}(mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}==1)\{
00423       fscanf(in, \textcolor{stringliteral}{"%d %lf"}, &(mat->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i]), &(mat->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i]));
00424     \}
00425     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}==2)\{
00426       fscanf(in, \textcolor{stringliteral}{"%d %lf %d %lf"}, &(mat->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i]), &(mat->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}
      [i]), &(mat->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i+1]), &(mat->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i+1]));
00427     \}
00428     \textcolor{keywordflow}{else}\{
00429       \textcolor{keywordflow}{return} 1;             \textcolor{comment}{//(nnz > 2) not implement}
00430     \}
00431     i+=mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz};  
00432   \}
00433   \textcolor{keywordflow}{if}(i!= mat->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m} * mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz} )\{
00434     printf(\textcolor{stringliteral}{"WARNNING data size doesn't fit\(\backslash\)n"});
00435   \}
00436   fclose(in);
00437   \textcolor{keywordflow}{return} 0;
00438 \}
00439 
00440 
00441 
\hypertarget{mapmat_8c_source_l00451}{}\hyperlink{group__matmap__group11_ga792b187cf2f23e526ecd5e2c3cbb9dab}{00451} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga792b187cf2f23e526ecd5e2c3cbb9dab}{MatSave}(\hyperlink{structMat}{Mat} *mat, \textcolor{keywordtype}{char} *filename)\{
00452   FILE *out;
00453   \textcolor{keywordtype}{char} fn [100];
00454   \textcolor{keywordtype}{int} i,j;
00455   \textcolor{keywordtype}{int} rank;
00456 \textcolor{preprocessor}{#if W\_MPI}
00457 \textcolor{preprocessor}{}  MPI\_Comm\_rank(mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &rank);
00458 \textcolor{preprocessor}{#else}
00459 \textcolor{preprocessor}{}  sprintf(fn,\textcolor{stringliteral}{"%s\_%d.dat"}, filename, rank);    
00460 \textcolor{preprocessor}{#endif}
00461 \textcolor{preprocessor}{}  out=fopen(fn,\textcolor{stringliteral}{"w"});
00462   \textcolor{keywordflow}{if}(out==NULL)\{
00463      printf(\textcolor{stringliteral}{"cannot open file %s"}, fn);
00464      \textcolor{keywordflow}{return} 1;
00465   \}
00466   \textcolor{keywordflow}{for}(i=0; i < (mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz} * mat->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}); i+=mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz})\{
00467     \textcolor{keywordflow}{for}(j=0; j< mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz} ; j++)\{
00468       fprintf(out,\textcolor{stringliteral}{"%d "},mat->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i+j]);
00469       fprintf(out,\textcolor{stringliteral}{"%f "}, mat->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i+j]);
00470     \}
00471     fprintf(out, \textcolor{stringliteral}{"\(\backslash\)n"});
00472   \}
00473   fclose(out);
00474   \textcolor{keywordflow}{return} 0;
00475 \} 
00476 
00477 
00478 
\hypertarget{mapmat_8c_source_l00489}{}\hyperlink{group__matmap__group11_gae31f7ccb10cda5c97e49f640feed1ad4}{00489} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_gae31f7ccb10cda5c97e49f640feed1ad4}{MatLocalShape}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{int} sflag)\{
00490   \textcolor{keywordtype}{int} *tmp\_indices;
00491 
00492   tmp\_indices = (\textcolor{keywordtype}{int} *) malloc((int64\_t) (A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}) * A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));    \textcolor{comment}{
      //allocate a tmp copy of indices tab to sort    }
00493   memcpy(tmp\_indices, A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}, (int64\_t) (A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}) * A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz} * \textcolor{keyword}{sizeof}
      (\textcolor{keywordtype}{int}));  \textcolor{comment}{//copy        }
00494 
00495 \textcolor{comment}{//  A->lcount = omp\_psort(tmp\_indices, A->m * A->nnz, sflag);           
      //sequential sort tmp\_indices}
00496   A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} = \hyperlink{group__matmap__group22_ga132957cdd06b08ad58760aab421bc3e1}{ssort}(tmp\_indices, A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m} * A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}, sflag);          \textcolor{comment}{
      //sequential sort tmp\_indices}
00497 
00498   A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices} = (\textcolor{keywordtype}{int} *) malloc( A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));      
00499   memcpy(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, tmp\_indices, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));      \textcolor{comment}{
      //copy tmp\_indices into lindices and free}
00500   free(tmp\_indices);     
00501 
00502   \hyperlink{group__matmap__group22_ga130490c253962e8ce30d4e0041e1d596}{sindex}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}, A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}
       * A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m});
00503   \textcolor{keywordflow}{return} 0;
00504 \}
00505 
00506 
00507 
00508 
00509 
00510 \textcolor{preprocessor}{#if W\_MPI}
00511 \textcolor{preprocessor}{}
\hypertarget{mapmat_8c_source_l00515}{}\hyperlink{group__matmap__group11_ga61b3b348d7c039aadfc3196e6b83535a}{00515} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga61b3b348d7c039aadfc3196e6b83535a}{MatComShape}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{int} flag, MPI\_Comm comm)\{  
00516   \textcolor{keywordtype}{int} size;
00517   \textcolor{keywordtype}{int} i, min, max, j;
00518   A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm} = comm;                   \textcolor{comment}{// set communivcator}
00519   A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag}=flag;
00520   MPI\_Comm\_size(A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &size);
00521   \textcolor{keywordflow}{if}((A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag}==BUTTERFLY || A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag}==BUTTERFLY\_BLOCKING\_1 || A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag}
      ==BUTTERFLY\_BLOCKING\_2) && \hyperlink{bitop_8c_a0713ef440514e81791d55128343959ff}{is\_pow\_2}(size)!=0)
00522     A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag}=RING;
00523   \textcolor{keywordflow}{switch}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag})\{
00524     \textcolor{keywordflow}{case} BUTTERFLY :
00525       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = \hyperlink{bitop_8c_ad0f0d6f1ceedfc8bdd3e76e7f8160abe}{log\_2}(size);
00526       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00527       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00528       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00529       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00530       \hyperlink{group__matmap__group22_gabe7077466aef706a7825e650a78f4e5e}{butterfly\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R},
       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, &(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}), &(A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count})
      , A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00531       \textcolor{keywordflow}{break};
00532     \textcolor{comment}{//==========================Modification added by Sebastien Cayrols :
       01/09/2015 , Berkeley}
00533     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_1 :
00534       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = \hyperlink{bitop_8c_ad0f0d6f1ceedfc8bdd3e76e7f8160abe}{log\_2}(size);
00535       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00536       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00537       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00538       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00539       \hyperlink{group__matmap__group22_gabe7077466aef706a7825e650a78f4e5e}{butterfly\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R},
       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, &(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}), &(A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count})
      , A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00540       \textcolor{keywordflow}{break};
00541     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_2 :
00542       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = \hyperlink{bitop_8c_ad0f0d6f1ceedfc8bdd3e76e7f8160abe}{log\_2}(size);
00543       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00544       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00545       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00546       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00547       \hyperlink{group__matmap__group22_gabe7077466aef706a7825e650a78f4e5e}{butterfly\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R},
       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, &(A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}), &(A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count})
      , A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00548       \textcolor{keywordflow}{break};
00549     \textcolor{keywordflow}{case} NOEMPTYSTEPRING :
00550       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = size;
00551       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00552       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00553       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00554       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00555       \hyperlink{group__matmap__group22_gab4bcafb298be124aaa5bfed34348b1ea}{ring\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, 
      A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00556       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} = A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount};
00557       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices};
00558       \textcolor{keywordflow}{break};
00559     \textcolor{comment}{//==========================End modification}
00560     \textcolor{keywordflow}{case} RING :
00561       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = size;
00562       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00563       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00564       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00565       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00566       \hyperlink{group__matmap__group22_gab4bcafb298be124aaa5bfed34348b1ea}{ring\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, 
      A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00567       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} = A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount};
00568       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices};
00569       \textcolor{keywordflow}{break};
00570     \textcolor{keywordflow}{case} NONBLOCKING :
00571       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = size;
00572       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00573       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00574       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00575       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00576       \hyperlink{group__matmap__group22_gab4bcafb298be124aaa5bfed34348b1ea}{ring\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, 
      A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00577       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} = A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount};
00578       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices};
00579       \textcolor{keywordflow}{break};
00580     \textcolor{keywordflow}{case} NOEMPTY :
00581       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = size;
00582       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00583       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00584       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00585       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00586       \hyperlink{group__matmap__group22_gab4bcafb298be124aaa5bfed34348b1ea}{ring\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, 
      A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00587       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} = A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount};
00588       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices};
00589       \textcolor{keywordflow}{break};
00590     \textcolor{keywordflow}{case} ALLTOALLV :
00591       A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} = size;
00592       A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate sending maps tab}
00593       A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R} = (\textcolor{keywordtype}{int}** ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}* ));                 \textcolor{comment}{
      //allocate receiving maps tab}
00594       A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate sending map sizes tab}
00595       A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR} = (\textcolor{keywordtype}{int}* ) malloc(A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                   \textcolor{comment}{
      //allocate receiving map size tab}
00596       \hyperlink{group__matmap__group22_gab4bcafb298be124aaa5bfed34348b1ea}{ring\_init}(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, 
      A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00597       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} = A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount};
00598       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices};
00599       \textcolor{keywordflow}{break};
00600     \textcolor{keywordflow}{case} ALLREDUCE :
00601       MPI\_Allreduce(&A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}[A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}-1], &max, 1, MPI\_INT, 
      MPI\_MAX, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});   \textcolor{comment}{//maximum index}
00602       MPI\_Allreduce(&A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}[0], &min, 1, MPI\_INT, MPI\_MIN, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}
      );       \textcolor{comment}{//}
00603       A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}=(max-min+1);
00604       A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices} = (\textcolor{keywordtype}{int} *) malloc(A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}))
      ; \textcolor{comment}{//warning }
00605       i=0;
00606       j=0;
00607       \textcolor{keywordflow}{while}( j<A->com\_count && i<A->lcount)\{ \textcolor{comment}{//same as subsetmap for a
       coutiguous set}
00608         \textcolor{keywordflow}{if}(min+j < A->lindices[i])\{
00609           j++;  
00610         \}
00611         \textcolor{keywordflow}{else}\{
00612           A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}[i]=j;
00613           i++;
00614           j++;
00615        \}
00616       \}
00617       \textcolor{keywordflow}{break};
00618   \}
00619  \textcolor{keywordflow}{return} 0;
00620 \}
00621 \textcolor{preprocessor}{#endif}
00622 \textcolor{preprocessor}{}
00623 
\hypertarget{mapmat_8c_source_l00630}{}\hyperlink{group__matmap__group12a_gaf757d9249d31d2839b3376ac2e3f5574}{00630} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group12a_gaf757d9249d31d2839b3376ac2e3f5574}{MatVecProd}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{double} *x, \textcolor{keywordtype}{double}* y, \textcolor{keywordtype}{int} pflag)\{
00631   \textcolor{keywordtype}{int} i, j, e;
00632   \textcolor{keywordflow}{for}(i=0; i<A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}; i++)                                        \textcolor{comment}{//             
       }
00633       y[i] = 0.0;
00634 
00635   e=0;
00636   \textcolor{keywordflow}{for}(i=0; i<A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}*A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}; i+=A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz})\{                                    \textcolor{comment}{
      //              }
00637     \textcolor{keywordflow}{for}(j=0; j<A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}; j++)\{                                 \textcolor{comment}{// }
00638       y[e] += A->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i+j] * x[A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i+j]];   
00639     \}
00640     e++;
00641   \}
00642   \textcolor{keywordflow}{return} 0;
00643 \};
00644 
00645 
00646 \textcolor{preprocessor}{#ifdef W\_MPI}
00647 \textcolor{preprocessor}{}
\hypertarget{mapmat_8c_source_l00658}{}\hyperlink{group__matmap__group12b_ga46ad4af50377be15a0aa50f416a53ade}{00658} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group12b_ga46ad4af50377be15a0aa50f416a53ade}{TrMatVecProd\_Naive}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{double} *y, \textcolor{keywordtype}{double}* x, \textcolor{keywordtype}{int} 
      pflag)\{
00659   \textcolor{keywordtype}{int} i, j, e, rank, size;
00660   \textcolor{keywordtype}{int} *rbuf, rbufcount;
00661   \textcolor{keywordtype}{double} *rbufvalues, *lvalues;
00662   \textcolor{keywordtype}{int} p, rp, sp, tag;
00663   MPI\_Request s\_request, r\_request;
00664   MPI\_Status status; 
00665    
00666   MPI\_Comm\_rank(A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &rank);                            \textcolor{comment}{//get rank and
       size of the communicator}
00667   MPI\_Comm\_size(A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &size);                            \textcolor{comment}{//}
00668   lvalues = (\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));        \textcolor{comment}{//
      allocate and set local values to 0.0}
00669   \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}; i++)                            \textcolor{comment}{//}
00670     lvalues[i]=0.0;                                             \textcolor{comment}{//}
00671 
00672   e=0;
00673   \textcolor{keywordflow}{for}(i=0; i<A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}; i++)\{                                       \textcolor{comment}{//local
       transform reduces              }
00674     \textcolor{keywordflow}{for}(j=0; j<A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}; j++)\{                                 \textcolor{comment}{//}
00675       lvalues[A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i*A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}+j]] += (A->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i*A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}
      +j]) * y[i];   
00676     \}
00677   \} 
00678 
00679   memcpy(x, lvalues, (A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount})*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));                         \textcolor{comment}{
      //copy local values into the result*/}
00680   MPI\_Allreduce(&(A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}), &(rbufcount), 1, MPI\_INT, MPI\_MAX, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}
      );       \textcolor{comment}{//find the max communication buffer sizes, and allocate}
00681 
00682   rbuf = (\textcolor{keywordtype}{int} *)    malloc(rbufcount * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));                     
00683   rbufvalues  = (\textcolor{keywordtype}{double} *) malloc(rbufcount * \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00684 
00685   tag=0;
00686   \textcolor{keywordflow}{for} (p=1; p < size; p++)\{     \textcolor{comment}{//loop : collective global reduce in ring-like
       fashion}
00687     rp = (size + rank - p)%size;
00688     sp = (rank + p)%size;
00689     MPI\_Send(&(A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}), 1, MPI\_INT, sp, 0, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});                               \textcolor{comment}{
      //exchange sizes}
00690     MPI\_Recv(&rbufcount, 1, MPI\_INT, rp, 0, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &status);            
00691     tag++;
00692     MPI\_Irecv(rbuf, rbufcount, MPI\_INT, rp, tag, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &r\_request);              \textcolor{comment}{
      //exchange local indices   }
00693     MPI\_Isend(A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, MPI\_INT, sp, tag, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}
      , &s\_request); 
00694     MPI\_Wait(&r\_request, &status);
00695     MPI\_Wait(&s\_request, &status);
00696     tag++;
00697     MPI\_Irecv(rbufvalues, rbufcount, MPI\_DOUBLE, rp, tag, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &
      r\_request);     \textcolor{comment}{//exchange local values}
00698     MPI\_Isend(lvalues, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, MPI\_DOUBLE, sp, tag, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &
      s\_request);
00699     tag++;
00700     MPI\_Wait(&r\_request, &status);
00701     \hyperlink{group__matmap__group22_ga28c05d496e6168337d8a466affc1d0ac}{m2m\_sum}(rbufvalues, rbuf, rbufcount, x, A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->
      \hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});          \textcolor{comment}{//sum in the result}
00702     MPI\_Wait(&s\_request, &status);
00703   \}
00704   free(lvalues);
00705   \textcolor{keywordflow}{return} 0;
00706 \}
00707 \textcolor{preprocessor}{#endif  }
00708 \textcolor{preprocessor}{}
00709 
\hypertarget{mapmat_8c_source_l00723}{}\hyperlink{group__matmap__group11_ga1a51d7e8153d33045482100bbd07d0a9}{00723} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga1a51d7e8153d33045482100bbd07d0a9}{TrMatVecProd}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{double} *y, \textcolor{keywordtype}{double}* x, \textcolor{keywordtype}{int} pflag)\{
00724   \textcolor{keywordtype}{double} *sbuf, *rbuf;
00725   \textcolor{keywordtype}{int} i, j, k, e;
00726   \textcolor{keywordtype}{int} nSmax, nRmax;
00727   \textcolor{keywordtype}{double} *lvalues;
00728 
00729   \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}; i++)                            \textcolor{comment}{//refresh
       vector}
00730     x[i]=0.0;                                           \textcolor{comment}{//}
00731 
00732   e=0;
00733   \textcolor{keywordflow}{for}(i=0; i< A->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m}*A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}; i+=A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz})\{                   \textcolor{comment}{//local
       transform reduce          }
00734     \textcolor{keywordflow}{for}(j=0; j< A->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz}; j++)\{
00735        x[A->\hyperlink{structMat_a47d869e53879ad1d2b0aed8f6f1f648a}{indices}[i+j]] += A->\hyperlink{structMat_a6239320537db64ae9c1432f31f51e04b}{values}[i+j] * y[e];        \textcolor{comment}{//}
00736     \}                                                   \textcolor{comment}{//}
00737     e++;                                                \textcolor{comment}{//}
00738   \}                                                     \textcolor{comment}{//}
00739 
00740 \textcolor{preprocessor}{#ifdef W\_MPI}
00741 \textcolor{preprocessor}{}  \hyperlink{mapmat_8c_a8b6ed129adf6485b891280470ba4e6df}{greedyreduce}(A, x);                                       \textcolor{comment}{//
      global reduce}
00742 \textcolor{preprocessor}{#endif}
00743 \textcolor{preprocessor}{}  \textcolor{keywordflow}{return} 0;
00744 \}
00745 
00746 
00747 
00748 
00749 
00750 
00751 \textcolor{preprocessor}{#ifdef W\_MPI}
00752 \textcolor{preprocessor}{}
\hypertarget{mapmat_8c_source_l00758}{}\hyperlink{group__matmap__group11_ga8e522200e7c693e4d81ff3ce3a1e24ff}{00758} \textcolor{keywordtype}{int} \hyperlink{group__matmap__group11_ga8e522200e7c693e4d81ff3ce3a1e24ff}{MatInfo}(\hyperlink{structMat}{Mat} *mat, \textcolor{keywordtype}{int} verbose, \textcolor{keywordtype}{char} *filename)\{
00759   FILE *out;
00760   \textcolor{keywordtype}{int} *n;
00761   \textcolor{keywordtype}{int} *sr;
00762   \textcolor{keywordtype}{int} *s;
00763   \textcolor{keywordtype}{int} nnzline, sparsity, maxstep, maxsize, sumline, total;
00764   \textcolor{keywordtype}{int} i, j, k;
00765   \textcolor{keywordtype}{char} fn [100];
00766   \textcolor{keywordtype}{int} rank, size;
00767   \textcolor{keywordtype}{int} master=0;
00768   MPI\_Comm\_rank(mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &rank);
00769   MPI\_Comm\_size(mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}, &size);
00770   
00771 
00772   \textcolor{keywordflow}{if}(rank==master)\{                     \textcolor{comment}{//master process saves data into
       filename\_info.txt}
00773     sprintf(fn,\textcolor{stringliteral}{"%s\_%s"}, filename, \textcolor{stringliteral}{"info.txt"});    
00774     out=fopen(fn,\textcolor{stringliteral}{"w"});
00775     \textcolor{keywordflow}{if}(out==NULL)\{
00776       printf(\textcolor{stringliteral}{"cannot open file %s\(\backslash\)n"}, fn);
00777       \textcolor{keywordflow}{return} 1;
00778     \}
00779     printf(\textcolor{stringliteral}{"open file %s ..."}, fn);
00780     fprintf(out, \textcolor{stringliteral}{"flag %d\(\backslash\)n"}, mat->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag});   \textcolor{comment}{//print matirx main description
       : flag (communication scheme), }
00781     fprintf(out, \textcolor{stringliteral}{"rows %d\(\backslash\)n "}, mat->\hyperlink{structMat_a1656ea8b949ef48d4f0939f675a6d075}{m});        \textcolor{comment}{//rows per process,}
00782     fprintf(out, \textcolor{stringliteral}{"nnz %d\(\backslash\)n"}, mat->\hyperlink{structMat_acd6e2a54ef05701b15d794040a3816a6}{nnz});      \textcolor{comment}{//nnz (number of non zero per
       row).}
00783     fprintf(out, \textcolor{stringliteral}{"\(\backslash\)n"}); \textcolor{comment}{//separator}
00784   \}
00785 
00786   \textcolor{comment}{/*n = (int* ) calloc(mat->lcount,sizeof(int));                //allocate     }
00787 \textcolor{comment}{  //printf("before gather %d\(\backslash\)n", rank);}
00788 \textcolor{comment}{  MPI\_Gather(&(mat->lcount), 1, MPI\_INT, n, 1, MPI\_INT, master, mat->comm);             
      //gather nbnonempty cols }
00789 \textcolor{comment}{  //printf("after gather %d\(\backslash\)n", rank);}
00790 \textcolor{comment}{}
00791 \textcolor{comment}{  if(rank==master)\{                     //master process saves data into
       filename\_info.txt}
00792 \textcolor{comment}{    fprintf(out, "cols :\(\backslash\)n");   //nnz (number of non zero per row).}
00793 \textcolor{comment}{    for(i=0; i<size; i++)               //}
00794 \textcolor{comment}{      fprintf(out, "%d ", n[i]);        //non-empty columns per process.}
00795 \textcolor{comment}{    fprintf(out, "\(\backslash\)n");                 //}
00796 \textcolor{comment}{  \}}
00797 \textcolor{comment}{  free(n); */}                           \textcolor{comment}{//free allocated tabs}
00798 
00799   nnzline = 0;                          \textcolor{comment}{//compute communication sparsity and
       maximum message size}
00800   sumline = 0;
00801   \textcolor{keywordflow}{for}(i=0; i<mat->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; i++)\{             \textcolor{comment}{//}
00802     sumline+=mat->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i];
00803     \textcolor{keywordflow}{if}(mat->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]==0)\{                        \textcolor{comment}{//}
00804       nnzline +=1;                      \textcolor{comment}{//}
00805     \}                                   \textcolor{comment}{//}
00806   \}                                     \textcolor{comment}{//}
00807   MPI\_Reduce(&nnzline, &sparsity, 1, MPI\_INT, MPI\_SUM, 0, mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});       \textcolor{comment}{
      //sparsity}
00808   MPI\_Reduce(&sumline, &total, 1, MPI\_INT, MPI\_SUM, 0, mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});  \textcolor{comment}{//
      sparsity}
00809   \textcolor{keywordflow}{if}(rank==master)\{                     \textcolor{comment}{//master process saves data into
       filename\_info.txt}
00810     fprintf(out, \textcolor{stringliteral}{"sparsity %d\(\backslash\)n"}, sparsity);    \textcolor{comment}{//}
00811     fprintf(out, \textcolor{stringliteral}{"total %d\(\backslash\)n"}, total);  \textcolor{comment}{//}
00812   \}
00813 
00814   maxsize =0;
00815   \textcolor{keywordflow}{for}(i=0; i<mat->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; i++)\{             \textcolor{comment}{//}
00816     MPI\_Reduce(&(mat->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[i]), &maxstep, 1, MPI\_INT, MPI\_MAX, 0, mat->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}
      );       \textcolor{comment}{//maximum message size}
00817     maxsize+=maxstep;                   \textcolor{comment}{//}
00818   \}                             \textcolor{comment}{//}
00819   \textcolor{keywordflow}{if}(rank==master)\{                             \textcolor{comment}{//master process saves data
       into filename\_info.txt}
00820     fprintf(out, \textcolor{stringliteral}{"maxsize %d\(\backslash\)n "}, maxsize);     \textcolor{comment}{//}
00821     fprintf(out, \textcolor{stringliteral}{"\(\backslash\)n"});                         \textcolor{comment}{//separator}
00822   \}                                             \textcolor{comment}{//}
00823 
00824  \textcolor{comment}{/* s = (int* ) calloc((mat->steps),sizeof(int));       //allocate steps}
00825 \textcolor{comment}{  MPI\_Reduce(mat->nS, s, mat->steps, MPI\_INT, MPI\_SUM, 0, mat->comm);   //
      imaximum message size}
00826 \textcolor{comment}{}
00827 \textcolor{comment}{  if(rank==master)\{                     //master process saves data into
       filename\_info.txt}
00828 \textcolor{comment}{    fprintf(out, "sumsteps :\(\backslash\)n");       //nnz (number of non zero per row).}
00829 \textcolor{comment}{    for(i=0; i<mat->steps; i++)         //}
00830 \textcolor{comment}{      fprintf(out, "%d ", s[i]);        //non-empty columns per process.}
00831 \textcolor{comment}{    fprintf(out, "\(\backslash\)n");                 //}
00832 \textcolor{comment}{  \}}
00833 \textcolor{comment}{  free(s);}
00834 \textcolor{comment}{}
00835 \textcolor{comment}{  if(verbose==1)\{}
00836 \textcolor{comment}{    sr = (int* ) calloc((mat->steps)*size,sizeof(int)); //allocate send/receive
       matrix}
00837 \textcolor{comment}{    //printf("before gather %d\(\backslash\)n", rank);}
00838 \textcolor{comment}{    MPI\_Gather(mat->nS, mat->steps, MPI\_INT, sr, mat->steps, MPI\_INT, master,
       mat->comm);       //gather nbnonempty cols}
00839 \textcolor{comment}{    //printf("after gather %d\(\backslash\)n", rank);}
00840 \textcolor{comment}{}
00841 \textcolor{comment}{    if(rank==master)\{                   //master process saves data into
       filename\_info.txt}
00842 \textcolor{comment}{    fprintf(out, "send/receive matrix\(\backslash\)n");      //separator}
00843 \textcolor{comment}{      for(i=0; i<size; i++)\{            //print collective description : }
00844 \textcolor{comment}{        if(mat->flag==BUTTERFLY)\{               //send-receive matrix}
00845 \textcolor{comment}{          for(j=0; j<size; j++)\{                //print send/receive matrix}
00846 \textcolor{comment}{            if(j>i)\{}
00847 \textcolor{comment}{              if(is\_pow\_2(j-i)==0)}
00848 \textcolor{comment}{                fprintf(out,"%d ", sr[i*(mat->steps)+log\_2(j-i)]);}
00849 \textcolor{comment}{              else}
00850 \textcolor{comment}{                fprintf(out,"%d ", 0);}
00851 \textcolor{comment}{            \}}
00852 \textcolor{comment}{            else if(i>j)\{}
00853 \textcolor{comment}{              if(is\_pow\_2(size+j-i)==0)}
00854 \textcolor{comment}{                fprintf(out,"%d ", sr[i*(mat->steps)+log\_2(size+j-i)]);}
00855 \textcolor{comment}{              else}
00856 \textcolor{comment}{                fprintf(out,"%d ", 0);}
00857 \textcolor{comment}{            \}}
00858 \textcolor{comment}{            else\{}
00859 \textcolor{comment}{              fprintf(out,"%d ", 0);}
00860 \textcolor{comment}{            \}}
00861 \textcolor{comment}{          \}}
00862 \textcolor{comment}{          fprintf(out, "\(\backslash\)n");}
00863 \textcolor{comment}{        \}}
00864 \textcolor{comment}{        else\{}
00865 \textcolor{comment}{          for(j=0; j<size; j++)\{                //print send/receive matrix}
00866 \textcolor{comment}{            if(j>i)\{}
00867 \textcolor{comment}{              fprintf(out,"%d ", sr[i*(mat->steps)+j-i]);}
00868 \textcolor{comment}{            \}}
00869 \textcolor{comment}{            else if(i>j)\{}
00870 \textcolor{comment}{              fprintf(out,"%d ", sr[(i+1)*(mat->steps)-i+j]);}
00871 \textcolor{comment}{            \}}
00872 \textcolor{comment}{            else\{ }
00873 \textcolor{comment}{              fprintf(out,"%d ", 0);}
00874 \textcolor{comment}{            \} }
00875 \textcolor{comment}{          \} }
00876 \textcolor{comment}{          fprintf(out, "\(\backslash\)n");}
00877 \textcolor{comment}{        \}}
00878 \textcolor{comment}{      \}}
00879 \textcolor{comment}{    \}}
00880 \textcolor{comment}{    free(sr);  }
00881 \textcolor{comment}{  \}*/}
00882    
00883   \textcolor{keywordflow}{if}(rank==master)\{                     \textcolor{comment}{//master process saves data into
       filename\_info.txt}
00884     fclose(out);
00885     printf(\textcolor{stringliteral}{"close %s\(\backslash\)n"}, fn);
00886   \}
00887   \textcolor{keywordflow}{return} 0; 
00888 \}
00889 \textcolor{preprocessor}{#endif}
00890 \textcolor{preprocessor}{}
00891 
00892 
00893 \textcolor{preprocessor}{#if W\_MPI                                                       }
\hypertarget{mapmat_8c_source_l00894}{}\hyperlink{mapmat_8h_a8b6ed129adf6485b891280470ba4e6df}{00894} \textcolor{preprocessor}{}\textcolor{keywordtype}{int} \hyperlink{mapmat_8c_a8b6ed129adf6485b891280470ba4e6df}{greedyreduce}(\hyperlink{structMat}{Mat} *A, \textcolor{keywordtype}{double}* x)\{
00895   \textcolor{keywordtype}{int} i, j, k;
00896   \textcolor{keywordtype}{int} nSmax, nRmax, nStot, nRtot;
00897   \textcolor{keywordtype}{double} *lvalues;
00898   lvalues = (\textcolor{keywordtype}{double} *) malloc(A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); \textcolor{comment}{//allocate and
       set to 0.0 local values}
00899   memcpy(lvalues, x, (A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}) *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double}));                \textcolor{comment}{//copy
       local values into result values}
00900   \textcolor{keywordtype}{double} *com\_val;
00901   \textcolor{keywordtype}{double} *out\_val;
00902   \textcolor{keywordtype}{int} ne=0;
00903   \textcolor{keywordflow}{switch}(A->\hyperlink{structMat_a0ab8c39abb15ab5d8d0d990a37dadcc2}{flag})\{
00904     \textcolor{keywordflow}{case} BUTTERFLY :
00905       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)                                  \textcolor{comment}{//
      compute max communication buffer size}
00906         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k] > nRmax)
00907           nRmax = A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k];
00908       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)
00909         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k] > nSmax)
00910           nSmax = A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k];
00911       com\_val=(\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00912       \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}; i++)
00913         com\_val[i]=0.0;
00914       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(lvalues, A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, com\_val, A->
      \hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count});
00915       \hyperlink{group__matmap__group22_ga3ab052e5ba3e18427574481f64916b3a}{butterfly\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRmax, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, 
      nSmax, com\_val, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00916       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(com\_val, A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}, x, A->
      \hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});
00917       free(com\_val);
00918       \textcolor{keywordflow}{break};
00919     \textcolor{comment}{//==========================Modification added by Sebastien Cayrols :
       01/09/2015 , Berkeley}
00920     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_1 :
00921       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)                                  \textcolor{comment}{//
      compute max communication buffer size}
00922         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k] > nRmax)
00923           nRmax = A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k];
00924       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)
00925         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k] > nSmax)
00926           nSmax = A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k];
00927       com\_val=(\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00928       \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}; i++)
00929         com\_val[i]=0.0;
00930       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(lvalues, A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, com\_val, A->
      \hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count});
00931       \hyperlink{group__matmap__group22_gaddc1509a3b18b1d35b7a4fc411eba3a6}{butterfly\_blocking\_1instr\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A
      ->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRmax, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, nSmax, com\_val, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00932       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(com\_val, A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}, x, A->
      \hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});
00933       free(com\_val);
00934       \textcolor{keywordflow}{break};
00935     \textcolor{keywordflow}{case} BUTTERFLY\_BLOCKING\_2 :
00936       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)                                  \textcolor{comment}{//
      compute max communication buffer size}
00937         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k] > nRmax)
00938           nRmax = A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k];
00939       \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)
00940         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k] > nSmax)
00941           nSmax = A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k];
00942       com\_val=(\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00943       \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}; i++)
00944         com\_val[i]=0.0;
00945       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(lvalues, A->\hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount}, com\_val, A->
      \hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count});
00946       \hyperlink{group__matmap__group22_gaddc1509a3b18b1d35b7a4fc411eba3a6}{butterfly\_blocking\_1instr\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A
      ->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRmax, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, nSmax, com\_val, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00947       \hyperlink{group__matmap__group22_ga3097d396b49c10414a79152f4ebd2902}{m2m}(com\_val, A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}, x, A->
      \hyperlink{structMat_a26f484e28815cb59e3cd5600f8832de4}{lindices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});
00948       free(com\_val);
00949       \textcolor{keywordflow}{break};
00950     \textcolor{keywordflow}{case} NOEMPTYSTEPRING :
00951       \textcolor{keywordflow}{for}(k=1; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)                           \textcolor{comment}{//compute max
       communication buffer size}
00952         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k] > nRmax)
00953           nRmax = A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k]; 
00954       nSmax = nRmax;  
00955       \hyperlink{group__matmap__group22_ga70fb12cfb290a86dc085d51ba13b2b41}{ring\_noempty\_step\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRmax, A
      ->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, nSmax, lvalues, x, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00956       \textcolor{keywordflow}{break};
00957     \textcolor{comment}{//==========================End modification}
00958     \textcolor{keywordflow}{case} RING :
00959       \textcolor{keywordflow}{for}(k=1; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)                           \textcolor{comment}{//compute max
       communication buffer size}
00960         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k] > nRmax)
00961           nRmax = A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k]; 
00962       nSmax = nRmax;  
00963       \hyperlink{group__matmap__group22_gadacbaae4e4aa8283e5fd4effbd61da30}{ring\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRmax, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, nSmax, 
      lvalues, x, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00964       \textcolor{keywordflow}{break};
00965     \textcolor{keywordflow}{case} NONBLOCKING :
00966       \hyperlink{group__matmap__group22_gaa30b9825dac2a7e8bbc56d4b1837fda7}{ring\_nonblocking\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->
      \hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, lvalues, x, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00967       \textcolor{keywordflow}{break};
00968     \textcolor{keywordflow}{case} NOEMPTY :
00969       \textcolor{keywordflow}{for}(k=1; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)
00970         \textcolor{keywordflow}{if}(A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k]!=0)
00971           ne++;  
00972       \hyperlink{group__matmap__group22_gaa9afd399996bf2b2b11dc6b4cdb9dda8}{ring\_noempty\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, ne, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}
      , ne, lvalues, x, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
00973       \textcolor{keywordflow}{break};
00974     \textcolor{keywordflow}{case} ALLREDUCE :
00975       com\_val=(\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00976       out\_val=(\textcolor{keywordtype}{double} *) malloc( A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count} *\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{double})); 
00977       \textcolor{keywordflow}{for}(i=0; i < A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}; i++)\{
00978         com\_val[i]=0.0;
00979         out\_val[i]=0.0;
00980       \}
00981       \hyperlink{alm_8c_a3215545f5ef51df80f796a4b727d6548}{s2m}(com\_val, lvalues, A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});
00982       \textcolor{comment}{/*for(i=0; i < A->com\_count; i++)\{}
00983 \textcolor{comment}{         printf("%lf ", com\_val[i]);}
00984 \textcolor{comment}{      \} */}     
00985       MPI\_Allreduce(com\_val, out\_val, A->\hyperlink{structMat_ada2d04e4ec38ac2ce21099145b3b5e11}{com\_count}, MPI\_DOUBLE, 
      MPI\_SUM, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm}); \textcolor{comment}{//maximum index}
00986       \textcolor{comment}{/*for(i=0; i < A->com\_count; i++)\{}
00987 \textcolor{comment}{         printf("%lf ", out\_val[i]);}
00988 \textcolor{comment}{      \} */}     
00989       \hyperlink{alm_8c_a025f3e840ed5ec45c53aedc002feff2e}{m2s}(out\_val, x, A->\hyperlink{structMat_acd1137be3acc4749cd1226022b9bbe67}{com\_indices}, A->\hyperlink{structMat_a983857e6f4ddb2c19a5119bcf1b6af63}{lcount});          
                             \textcolor{comment}{//sum receive buffer into values}
00990       free(com\_val);
00991       free(out\_val);
00992       \textcolor{keywordflow}{break};
00993       \textcolor{keywordflow}{case} ALLTOALLV :
00994          nRtot=nStot=0;
00995          \textcolor{keywordflow}{for}(k=0; k< A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}; k++)\{                               \textcolor{comment}{//
      compute buffer sizes}
00996              nRtot += A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}[k];                \textcolor{comment}{// to receive}
00997              nStot += A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}[k];                \textcolor{comment}{// to send}
00998        \}
00999 
01000       \hyperlink{group__matmap__group22_ga7aeab779fca40cc4c4e402192f89d242}{alltoallv\_reduce}(A->\hyperlink{structMat_a162f62ae4515e7d13f7de19c3bdb5583}{R}, A->\hyperlink{structMat_ab82b7beab655b5c6d0739a345d0566ed}{nR}, nRtot, A->\hyperlink{structMat_a1a774da8e5eb2c07a70491f3b14b96c7}{S}, A->\hyperlink{structMat_a17303d0444340f5349c9d23628a15914}{nS}, 
      nStot, lvalues, x, A->\hyperlink{structMat_a1f42610fea23791bc58f95d445a63838}{steps}, A->\hyperlink{structMat_a9a3894b7f67951ccae6fa1446fd00200}{comm});
01001       \textcolor{keywordflow}{break};
01002   \}
01003   free(lvalues);
01004   \textcolor{keywordflow}{return} 0;
01005 \}
01006 \textcolor{preprocessor}{#endif}
01007 \textcolor{preprocessor}{}
01008 
\end{DoxyCode}
